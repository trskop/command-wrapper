# shellcheck shell=bash
# vim: filetype=direnv

function use_cw_dev_setup() {
    local dev_dir="$1"; shift
    dev_dir="$(cd "${dev_dir}" && pwd)"

    local root
    root="$(dirname "${dev_dir}")"  # TODO: Move this to dot.envrc?

    # See `README.md` for information about directory structure.
    local -r config_dir="${dev_dir}/config"
    local -r cw_dev_dir="${config_dir}/cw-dev"

    # Import Command Wrapper Direnv library in `.envrc`.
    #
    # For more information see `command-wrapper-direnv-library(7)` manual page,
    # or call:
    #
    # ```Bash
    # cw-dev help --man direnv-library
    # ```
    #
    # shellcheck source=/dev/null
    source <(cw-dev completion --library --direnv --content)

    # These options are used by configuration 'cw-dev' configuration files.
    {
        env root="${root}" cw-dev config --dhall \
        | command_wrapper_dhall_cache 'cw-dev' 'options.dhall' "${cw_dev_dir}"
    } <<< '
        { Type = { projectRoot : Text }
        , default.projectRoot = env:root as Text
        }
    '

    # Configuration files used by 'cw-dev', that are not automatically tracked.
    local -r -a watch_files=(
        "${dev_dir}/config/cw-dev/default/exec-aliases.dhall"
        "${dev_dir}/config/cw-dev/command-wrapper-exec.dhall"
    )
    for file in "${watch_files[@]}"; do
        watch_file "${file}"
    done

    use command_wrapper 'cw-dev' "${config_dir}"
}
