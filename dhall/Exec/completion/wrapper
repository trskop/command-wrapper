let CommandWrapper = ~/.config/command-wrapper/Types.dhall

let commandWrapper = ~/.config/command-wrapper/library.dhall

let noExtraEnvironment = commandWrapper.command.emptyEnvironment

let Shell/toText =
        λ(shell : CommandWrapper.Shell)
      → merge { Bash = "bash", Fish = "fish", Zsh = "zsh" } shell

let mkArguments =
        λ(shell : CommandWrapper.Shell)
      → λ(index : Natural)
      → λ(words : List Text)
      →   [ "--index=${Natural/show index}"
          , "--shell=${merge
                       { Bash = "bash", Fish = "fish", Zsh = "zsh" }
                       shell}"
          , "--"
          ]
        # words

in    λ(options : {toolset : Text, expression : Text, command : Text})
    → λ(workingDirectory : Optional Text)
    → λ(prefixArguments : List Text)
    → λ(shell : CommandWrapper.Shell)
    → λ(index : Natural)
    → λ(words : List Text)
    → { command =
          options.toolset
      , arguments =
          let adjusted-index = index + List/length Text prefixArguments

          let arguments =
                mkArguments
                shell
                adjusted-index
                ([options.command] # prefixArguments # words)

          in    [ "completion"
                , "--wrapper"
                , "--expression=${options.expression}"
                , "--exec"
                , "--"
                ]
              # arguments
      , environment =
          noExtraEnvironment
      , searchPath =
          True
      , workingDirectory =
          workingDirectory
      }

-- vim: filetype=dhall
